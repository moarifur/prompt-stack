# Complete Guide: Setting Up Prisma with Neon PostgreSQL and Next.js

This guide walks you through setting up a full-stack Next.js application with Prisma ORM and Neon PostgreSQL database.

## Table of Contents
1. [Database Setup with Neon](#1-database-setup-with-neon)
2. [Install and Configure Prisma](#2-install-and-configure-prisma)
3. [Define Database Schema](#3-define-database-schema)
4. [Run Migrations](#4-run-migrations)
5. [Seed the Database](#5-seed-the-database)
6. [Connect Prisma to Next.js](#6-connect-prisma-to-nextjs)
7. [Fetch and Display Data](#7-fetch-and-display-data)

---

## 1. Database Setup with Neon

### Create a Neon Database

1. Visit [neon.tech](https://neon.tech) and sign in
2. You'll be redirected to [https://console.neon.tech/app/projects](https://console.neon.tech/app/projects)
3. Create a new project (e.g., "prompt-stack")
4. Copy your connection URL from the dashboard

Your connection URL will look like this:
```
postgresql://neondb_owner:npg_4mOZnNL6PDAz@ep-tiny-pine-ado7gdy7-pooler.c-2.us-east-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require
```

---

## 2. Install and Configure Prisma

### Install Required Packages

```bash
# Install Prisma CLI (for migrations, generation, etc.)
npm install prisma --save-dev

# Install Prisma Client (used by your app)
npm install @prisma/client
```

### Initialize Prisma

```bash
npx prisma init
```

**Output:**
```
‚úî Your Prisma schema was created at prisma/schema.prisma
  You can now open it in your favorite editor.

warn You already have a .gitignore file. Don't forget to add `.env` in it to not commit any private information.
```

This command creates:
- A `prisma` folder with `schema.prisma` file
- An `.env` file with a placeholder `DATABASE_URL`

### Configure Database Connection

Open the `.env` file and replace the placeholder with your Neon connection URL:

```env
# .env
DATABASE_URL='postgresql://neondb_owner:npg_4mOZnNL6PDAz@ep-tiny-pine-ado7gdy7-pooler.c-2.us-east-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require'
```

‚ö†Ô∏è **Important:** Make sure `.env` is in your `.gitignore` to avoid committing sensitive credentials.

---

## 3. Define Database Schema

Open `prisma/schema.prisma` and ensure it looks like this:

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id    Int     @id @default(autoincrement())
  email String  @unique
  name  String?
  posts Post[]
}

model Post {
  id        Int     @id @default(autoincrement())
  title     String
  content   String?
  published Boolean @default(false)
  authorId  Int
  author    User    @relation(fields: [authorId], references: [id])
}
```

This schema defines:
- **User** model with id, email, name, and posts
- **Post** model with id, title, content, published status, and author relationship

---

## 4. Run Migrations

Create the database tables and generate the Prisma Client:

```bash
npx prisma migrate dev
```

**You'll be prompted to name your migration:**
```
‚àö Enter a name for the new migration: ... init
```

**Output:**
```
Applying migration `20251014082759_init`

The following migration(s) have been created and applied from new schema changes:

migrations/
  ‚îî‚îÄ 20251014082759_init/
    ‚îî‚îÄ migration.sql

Your database is now in sync with your schema.

‚úî Generated Prisma Client (v6.17.1) to .\node_modules\.prisma\client in 136ms
```

### What Just Happened?

1. **Synced database** - Created tables in your Neon PostgreSQL database
2. **Created migration file** - Added a timestamped migration in `prisma/migrations/`
3. **Generated Prisma Client** - Created type-safe database client in `node_modules/.prisma/client`

---

## 5. Seed the Database

Seeding populates your database with initial test data.

### Step 1: Create Seed File

Create `prisma/seed.js`:

```javascript
// prisma/seed.js

import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

const userData = [
    {
        name: "Alice",
        email: "alice@prisma.io",
        posts: {
            create: [
                {
                    title: "Join the Prisma Discord",
                    content: "https://pris.ly/discord",
                    published: true
                },
                {
                    title: "Prisma on YouTube",
                    content: "https://pris.ly/youtube"
                }
            ]
        }
    },
    {
        name: "Bob",
        email: "bob@prisma.io",
        posts: {
            create: [
                {
                    title: "Follow Prisma on Twitter",
                    content: "https://www.twitter.com/prisma",
                    published: true
                }
            ]
        }
    }
]

export async function main() {
    for (const u of userData) {
        await prisma.user.create({ data: u })
    }
    console.log('Database seeded successfully!')
}

main()
    .catch((e) => {
        console.error(e)
        process.exit(1)
    })
    .finally(async () => {
        await prisma.$disconnect()
    })
```

### Step 2: Configure Package.json

Add the seed command and module type to your `package.json`:

```json
{
  "type": "module",
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start"
  },
  "prisma": {
    "seed": "node prisma/seed.js"
  },
  "dependencies": {
    // ... your dependencies
  }
}
```

**Important Configuration Notes:**
- `"type": "module"` enables ES modules (required for `import` statements)
- `"seed": "node prisma/seed.js"` tells Prisma how to run your seed file

### Step 3: Run the Seed Command

```bash
npx prisma db seed
```

**Output:**
```
Environment variables loaded from .env
Running seed command `node prisma/seed.js` ...
Database seeded successfully!

üå±  The seed command has been executed.
```

---

## 6. Connect Prisma to Next.js

Create a singleton Prisma Client instance to use throughout your Next.js app.

### Create Database Connection File

Create `src/lib/db.js`:

```javascript
// src/lib/db.js

import { PrismaClient } from '@prisma/client'

const globalForPrisma = globalThis

const prisma = globalForPrisma.prisma || new PrismaClient()

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma

export default prisma
```

### Why This Pattern?

- **Prevents multiple instances** - In development, Next.js hot-reloading can create multiple Prisma Client instances
- **Global singleton** - Reuses the same client instance across hot reloads
- **Production-safe** - Only creates the global instance in development mode

### Optional: Add Environment Variable

Add to your `.env` file:

```env
# .env
DATABASE_URL='your-neon-connection-url'

# Node environment
NODE_ENV='development'
```

---

## 7. Fetch and Display Data

Now you can use Prisma in your Next.js pages and components.

### Example: Home Page with Server Component

```javascript
// app/page.js

import prisma from '@/lib/db'
import { Button } from "@/components/ui/button"

const HomePage = async () => {
    // Fetch all users with their posts
    const users = await prisma.user.findMany({
        include: {
            posts: true
        }
    })

    return (
        <div className="container mx-auto p-8">
            <h1 className="text-5xl font-bold mb-8">My Users</h1>

            <div className="grid gap-6">
                {users.map((user) => (
                    <div key={user.id} className="border p-4 rounded-lg">
                        <h2 className="text-2xl font-semibold">{user.name}</h2>
                        <p className="text-gray-600">{user.email}</p>

                        <div className="mt-4">
                            <h3 className="font-medium mb-2">Posts:</h3>
                            <ul className="list-disc list-inside">
                                {user.posts.map((post) => (
                                    <li key={post.id}>
                                        {post.title}
                                        {post.published && <span className="text-green-600"> ‚úì</span>}
                                    </li>
                                ))}
                            </ul>
                        </div>
                    </div>
                ))}
            </div>

            {/* Debug view */}
            <details className="mt-8">
                <summary className="cursor-pointer">View Raw Data</summary>
                <pre className="bg-gray-100 p-4 rounded mt-2 overflow-auto">
                    {JSON.stringify(users, null, 2)}
                </pre>
            </details>
        </div>
    )
}

export default HomePage
```

---

## Common Prisma Commands Reference

```bash
# Generate Prisma Client after schema changes
npx prisma generate

# Create and apply a new migration
npx prisma migrate dev

# Apply migrations in production
npx prisma migrate deploy

# Seed the database
npx prisma db seed

# Open Prisma Studio (GUI for your database)
npx prisma studio

# Reset database (‚ö†Ô∏è deletes all data)
npx prisma migrate reset

# View current migration status
npx prisma migrate status
```

---

## Troubleshooting

### Issue: "ERR_UNSUPPORTED_DIR_IMPORT"
**Solution:** Make sure `generator client` in `schema.prisma` doesn't have a custom `output` path. Remove any `output` line and regenerate:
```bash
npx prisma generate
```

### Issue: "@prisma/client did not initialize yet"
**Solution:** Run `npx prisma generate` after any schema changes.

### Issue: "jsx is not recognized"
**Solution:** Change seed command in `package.json` from `"jsx prisma/seed.js"` to `"node prisma/seed.js"` and add `"type": "module"`.

### Issue: Multiple Prisma instances in development
**Solution:** Use the singleton pattern shown in `src/lib/db.js` above.

---

## Best Practices

1. **Always add `.env` to `.gitignore`** to protect database credentials
2. **Use migrations** instead of `prisma db push` for production-ready workflows
3. **Create a singleton Prisma Client** to avoid connection issues in Next.js
4. **Use Server Components** (Next.js 13+) for database queries when possible
5. **Add indexes** to frequently queried fields in your schema
6. **Use transactions** for operations that need to be atomic

---

## Next Steps

- Explore [Prisma Relations](https://www.prisma.io/docs/concepts/components/prisma-schema/relations)
- Learn about [Prisma Middleware](https://www.prisma.io/docs/concepts/components/prisma-client/middleware)
- Implement [API Routes](https://nextjs.org/docs/pages/building-your-application/routing/api-routes) for CRUD operations
- Add [Authentication](https://next-auth.js.org/) with NextAuth.js
- Deploy to [Vercel](https://vercel.com) with automatic Neon integration

---

## Resources

- [Prisma Documentation](https://www.prisma.io/docs)
- [Neon Documentation](https://neon.tech/docs/introduction)
- [Next.js Documentation](https://nextjs.org/docs)
- [Prisma Schema Reference](https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference)